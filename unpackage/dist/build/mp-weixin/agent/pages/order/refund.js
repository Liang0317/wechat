(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["agent/pages/order/refund"],{4632:function(e,r,n){"use strict";(function(e,r){var t=n("47a9");n("65e9");t(n("3240"));var o=t(n("b5a7"));e.__webpack_require_UNI_MP_PLUGIN__=n,r(o.default)}).call(this,n("3223")["default"],n("df3c")["createPage"])},"7c60":function(e,r,n){},b5a7:function(e,r,n){"use strict";n.r(r);var t=n("c6df"),o=n("ecd8");for(var i in o)["default"].indexOf(i)<0&&function(e){n.d(r,e,(function(){return o[e]}))}(i);n("cfb8");var u=n("828b"),a=Object(u["a"])(o["default"],t["b"],t["c"],!1,null,null,null,!1,t["a"],void 0);r["default"]=a.exports},b712:function(e,r,n){"use strict";var t=n("47a9");Object.defineProperty(r,"__esModule",{value:!0}),r.default=void 0;var o=t(n("7eb4")),i=t(n("ee10")),u=t(n("7ca3")),a=n("8f59");function c(e,r){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);r&&(t=t.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,t)}return n}function d(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?c(Object(n),!0).forEach((function(r){(0,u.default)(e,r,n[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))}))}return e}var f={components:{},data:function(){return{isLoad:!1,options:{},statusType:{"-1":"已取消",1:"待支付",2:"待接单",3:"待服务",4:this.$t("action.attendantName")+"出发",5:this.$t("action.attendantName")+"到达",6:"服务中",7:"已完成",8:"待转单"},refundForm:{},lockTap:!1}},computed:(0,a.mapState)({primaryColor:function(e){return e.config.configInfo.primaryColor},subColor:function(e){return e.config.configInfo.subColor},configInfo:function(e){return e.config.configInfo},userInfo:function(e){return e.user.userInfo}}),onLoad:function(e){var r=e.agent,n=void 0===r?0:r;e.agent=1*n,this.options=e,this.initIndex()},methods:d(d(d({},(0,a.mapActions)(["getConfigInfo","getCoachInfo"])),(0,a.mapMutations)(["updateTechnicianItem"])),{},{initIndex:function(){var e=arguments,r=this;return(0,i.default)(o.default.mark((function n(){var t,i,u,a,c,d,f;return o.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(t=e.length>0&&void 0!==e[0]&&e[0],r.configInfo.id&&!t){n.next=4;break}return n.next=4,r.getConfigInfo();case 4:return r.$util.setNavigationBarColor({bg:r.primaryColor}),i=r.options,u=i.id,a=i.agent,c=a?"agent":"admin",n.prev=7,n.next=10,r.$api[c].canRefundOrderInfo({order_id:u});case 10:d=n.sent,d.is_check=!1,d.refund_car_price=d.car_price,d.total_refund_price=0,d.all_refund_num=0,f=0,d.order.map((function(e){e.order_goods.map((function(e){var r=e.residue_material_price,n=e.residue_service_price,t=e.can_refund_num,o=e.true_price,i=e.material_price;f+=t,e.is_check=!1,e.true_single_price=o,e.true_single_material_price=i,o=(n/t).toFixed(2),i=(r/t).toFixed(2),e.true_price=o,e.material_price=i,e.refund_price=o,e.refund_material_price=i;var u=1*(o*t+i*t).toFixed(2),a=1*(1*n+1*r).toFixed(2);e.total_refund_price=u>a?a:u,e.true_total_refund_price=a,e.refund_num=t})),e.time_text=r.$util.formatTime(1e3*e.start_time,"YY-M-D h:m")+" - "+r.$util.formatTime(1e3*e.end_time,"YY-M-D h:m")})),d.can_refund_num=f,f||(d.total_refund_price=d.car_price),r.refundForm=d,r.isLoad=!0,n.next=26;break;case 23:n.prev=23,n.t0=n["catch"](7),setTimeout((function(){r.$util.back(),r.$util.getPage(-2).initRefresh(),r.$util.goUrl({url:1,openType:"navigateBack"})}),2e3);case 26:case"end":return n.stop()}}),n,null,[[7,23]])})))()},initRefresh:function(){this.initIndex(!0)},changeNum:function(e,r,n){var t=this;return(0,i.default)(o.default.mark((function i(){var u,a,c,d;return o.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:if(u=t.refundForm.order[e].order_goods[r],a=u.refund_num,c=u.can_refund_num,d=a+n,!(d>c||d<1)){o.next=5;break}return t.$util.showToast({title:d?"数量不可大于".concat(c):"数量至少为1"}),o.abrupt("return");case 5:t.refundForm.order[e].order_goods[r].refund_num=d,t.handleCheckOrderItem(0,e,r);case 7:case"end":return o.stop()}}),i)})))()},checkInput:function(e,r,n,t){var o=this,i=this.$util.formatMoney(e.detail.value);this.$nextTick((function(){-1==r?o.refundForm[t]=i:o.refundForm.order[r].order_goods[n][t]=i}))},handleCheckOrderItem:function(){var e=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=this.refundForm,i=o.is_check,u=o.car_price,a=o.refund_car_price,c=o.can_refund_num;if(1==r){var d=this.refundForm.order[n].order_goods[t].is_check;this.refundForm.order[n].order_goods[t].is_check=!d}if(2==r&&this.refundForm.order.map((function(e){e.order_goods.map((function(e){e.is_check=!i}))})),3==r){var f=/^(([1-9][0-9]*)|(([0]\.\d{1,2}|[1-9][0-9]*\.\d{1,2})))$/;f.test(a)||(a=0),1*a>u&&(a=u),this.$nextTick((function(){e.refundForm.refund_car_price=a}))}if(0==r){var _=this.refundForm.order[n].order_goods[t],s=_.residue_service_price,l=_.residue_material_price,p=_.true_single_price,m=_.true_single_material_price,g=_.can_refund_num,h=_.refund_num,v=_.refund_price,b=_.refund_material_price,k=_.true_total_refund_price,F=/^(([1-9][0-9]*)|(([0]\.\d{1,2}|[1-9][0-9]*\.\d{1,2})))$/;F.test(v)&&1*v!=0||(v=1*s===0?0:.01),F.test(b)||(b=0),p=g===h?(1*s/h).toFixed(2):p,m=g===h?(1*l/h).toFixed(2):m,v=1*v>1*p?p:v,b=1*b>1*m?m:b;var x=(v*h+b*h).toFixed(2);this.$nextTick((function(){e.refundForm.order[n].order_goods[t].true_price=p,e.refundForm.order[n].order_goods[t].refund_price=v,e.refundForm.order[n].order_goods[t].material_price=m,e.refundForm.order[n].order_goods[t].refund_material_price=b,e.refundForm.order[n].order_goods[t].total_refund_price=1*x>k?k:x}),0)}setTimeout((function(){var r=0,n=0,t=0;e.refundForm.order.map((function(e){e.order_goods.map((function(e){e.is_check?(r+=1*e.total_refund_price,n+=e.refund_num):t++}))})),a=c===n?a:0,r+=1*a,e.refundForm.total_refund_price=r.toFixed(2),e.refundForm.all_refund_num=n,e.refundForm.is_check=0===t}),100)},toConfirmRefund:function(){var e=this;return(0,i.default)(o.default.mark((function r(){var n,t,i,u,a,c,d,f,_,s,l;return o.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:if(n=JSON.parse(JSON.stringify(e.refundForm)),t=n.can_refund_num,i=n.all_refund_num,u=n.refund_car_price,a=n.order,u=t===i?u:0,c=[],d=0,f=0,_=a.filter((function(e){return!e.is_add})),!(_.length>0)){r.next=12;break}if(_[0].order_goods.map((function(e){d+=e.can_refund_num,e.is_check&&(f+=e.refund_num)})),d!==f||t===i){r.next=12;break}return e.$message.error("请把加钟项目一并退款哦"),r.abrupt("return");case 12:if(a.map((function(e){var r=e.order_goods.filter((function(e){return e.is_check}));if(r.length>0){var n=r.map((function(e){var r=e.refund_num,n=e.refund_price,t=e.refund_material_price,o=e.residue_service_price,i=e.residue_material_price,u=1*(n*r).toFixed(2),a=1*(t*r).toFixed(2);return{id:e.id,num:r,true_price:u>o?o:u,material_price:a>i?i:a}}));c.push({order_id:e.order_id,list:n,car_price:e.is_add?0:u})}})),0===c.length&&c.push({order_id:a[0].order_id,list:[],car_price:u}),s=e.options.agent,l=s?"agent":"admin",!e.lockTap){r.next=18;break}return r.abrupt("return");case 18:return e.lockTap=!0,e.$util.showLoading(),r.prev=20,r.next=23,e.$api[l].applyOrderRefund({order:c});case 23:e.$util.hideAll(),e.$util.showToast({title:"操作成功"}),setTimeout((function(){e.$util.back(),e.$util.getPage(-2).initRefresh(),e.$util.goUrl({url:1,openType:"navigateBack"})}),2e3),r.next=32;break;case 28:r.prev=28,r.t0=r["catch"](20),e.$util.hideAll(),e.lockTap=!1;case 32:case"end":return r.stop()}}),r,null,[[20,28]])})))()}})};r.default=f},c6df:function(e,r,n){"use strict";n.d(r,"b",(function(){return t})),n.d(r,"c",(function(){return o})),n.d(r,"a",(function(){}));var t=function(){var e=this,r=e.$createElement,n=(e._self._c,e.isLoad?e.__map(e.refundForm.order,(function(r,n){var t=e.__get_orig(r),o=r.order_goods.length>0&&0==n,i=o?e.__map(r.order_goods,(function(n,t){var o=e.__get_orig(n),i=n.is_check&&t!=r.order_goods.length-1,u=2!=r.pay_type?[3,4,5].includes(r.pay_type):null;return{$orig:o,g1:i,g2:u}})):null;return{$orig:t,g0:o,l0:i}})):null),t=e.isLoad?e.refundForm.order.length:null,o=e.isLoad&&t>1?e.__map(e.refundForm.order,(function(r,n){var t=e.__get_orig(r),o=r.order_goods.length>0&&0!=n,i=o?e.__map(r.order_goods,(function(n,t){var o=e.__get_orig(n),i=n.is_check&&t!=r.order_goods.length-1,u=2!=r.pay_type?[3,4,5].includes(r.pay_type):null;return{$orig:o,g5:i,g6:u}})):null;return{$orig:t,g4:o,l2:i}})):null;e._isMounted||(e.e0=function(r){return r.stopPropagation(),e.$util.goUrl({url:1,openType:"navigateBack"})}),e.$mp.data=Object.assign({},{$root:{l1:n,g3:t,l3:o}})},o=[]},cfb8:function(e,r,n){"use strict";var t=n("7c60"),o=n.n(t);o.a},ecd8:function(e,r,n){"use strict";n.r(r);var t=n("b712"),o=n.n(t);for(var i in t)["default"].indexOf(i)<0&&function(e){n.d(r,e,(function(){return t[e]}))}(i);r["default"]=o.a}},[["4632","common/runtime","common/vendor"]]]);